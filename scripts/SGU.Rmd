---
title: "SGU 2020 Science or Fiction Stats"
author: "Wayne Heller"
date: "May 23, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 18, fig.height = 14)
```

``` {r loaddata, echo=FALSE}
library(readxl)
library(dplyr)
library(reshape2)
library(knitr)
library(scales)
library(ggplot2)
library(gridExtra)
library(forcats)

debug_flag = FALSE # See description below.  If TRUE, will show the summarization values from spreadsheet as a validation
Episode_range_TY = 756:766
Episode_range_LY = 704:755
Mulligan_Episodes = c(766)
Current_Year = 2020 # There is one place in the code where I've not yet been able to parameterize the Current Year.  Do a Seach and Replace to find.
Last_Year = 2019
XL_SHEET_2017_SUMMARY = 4
XL_SHEET_2018_SUMMARY = 5
XL_SHEET_2019_SUMMARY = 6
XL_SHEET_2020_SUMMARY = 7
```

## Background
The Skeptics Guide to the Universe is a weekly podcast hosted by Dr. Steven Novella.  Each week during this segment of the podcast, Dr. Novella presents his panel of skeptics with 3 or 4 science-related news items, 1 of which is fiction.  And each panelist must determine which is the fiction.

## Year End Episode
At the end of the calendar year, Dr. Novella host a year in review episode where the panel reviews their performance at Science or Fiction.  

## `r Current_Year` Summary - Episodes# `r Episode_range_TY [1]` - `r tail(Episode_range_TY ,1)`

* NOTE: Episode 766  - the correct answer was negated in a subsequent episode due to an error in the question. A correct answer is awarded to all panelists for this episode.


## `r Current_Year` Summary Statistics 
 

``` {r readstats, echo = FALSE}
# This code has evolved over time, in the first iteration, markdown was simply used to read summary values from the source data
# in Excel and present it on an HTML page published to RPubs.com.  In the next version, the Excel file was modified to put the
# panelist answers on a separate tab in tidy format.  The revised markdown reads the data and does the summarization.  Since
# both versions exist in the same Excel file, this code is able to create a markdown file that shows both, the summary from Excel
# and the calculated summarizations.  

pathtofile <- file.path("..",'SGU_Science_or_Fiction.xlsx')
Rogues <- c("Steve", "Bob", "Evan", "Cara", "Jay")



# Creates a dataframe from the Summary Results tab of the Excel file
# Can be used as a validation to check calculations and to pull out summaries from 2017 when the data collection approach was different.  Did not begin using Answers tab until 2018
dfSGUSummary <- readxl::read_excel(pathtofile, sheet = XL_SHEET_2020_SUMMARY )
dfSGUSummary <- as.data.frame(dfSGUSummary)
rownames(dfSGUSummary) <- dfSGUSummary$Statistic
dfSGUSummary <- select(dfSGUSummary, -Statistic)
dfSGUSummary <- select(dfSGUSummary, c(Rogues, "ALL"))
dfSGUSummary <- t(dfSGUSummary)

# Want to change to not filter down to the current year range right away so that we can do smarter YoY changes
# And cummulative statistics

dfEpisodeData <- readxl::read_excel(pathtofile, sheet = 1 )
dfEpisodeData <- as.data.frame(dfEpisodeData)
dfEpisodeData <- select(dfEpisodeData, c(1,2,7,8)) # %>% filter(Episode %in% Episode_range_TY )
    
dfItemsSelected <- readxl::read_excel(pathtofile, sheet =2)
dfItemsSelected <- as.data.frame(dfItemsSelected)
dfItemsSelected <- select(dfItemsSelected, c('Episode', 'Panelist', 'ItemSelected', 'AnsweringOrder'))
#dfItemsSelected <- filter(dfItemsSelected, Episode %in% Episode_range_TY )
    
dfFictionItems <- select(dfEpisodeData, c('Episode', 'FictionItem', 'Theme'))

dfItemsSelected <- inner_join(dfItemsSelected, dfFictionItems, by='Episode')
dfItemsSelected$Correct <- mapply(ifelse, test = (dfItemsSelected$ItemSelected == dfItemsSelected$FictionItem), yes = 1, no = 0 )
# In 2020 Added this code to handle handle episodes that due to an issue with the question(s), all panelists answers are deemed correct.
#dfItemsSelected <- filter(dfItemsSelected, Episode %in% Mulligan_Episodes) %>% mutate(Correct = 1)
dfItemsSelected[dfItemsSelected$Episode %in% Mulligan_Episodes,]$Correct = 1
dfItemsSelected$Theme <- mapply(ifelse, test = !is.na(dfItemsSelected$Theme), yes = 'With Theme', no = 'Without Theme')

dfPanelistPerf <- dfItemsSelected %>% select(Episode, AnsweringOrder, Correct, Panelist, Theme) %>% filter(Panelist %in% Rogues) 

dfOverallPerf <- dfItemsSelected %>% select(Episode, AnsweringOrder, Correct, Panelist, Theme) # %>% filter(Panelist %in% Rogues)

# Append number correct for each episode to dfEpisodeData
dfCorrect <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% summarise(CorrectAnswers = sum(Correct)))
dfEpisodeData <- inner_join(dfEpisodeData, dfCorrect, by='Episode')

# Append panelist who answered first for each episode to dfEpisodeData
dfFirstPanelist <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% filter(AnsweringOrder==1) %>% select(Episode, FirstPanelist = Panelist))
dfEpisodeData <- inner_join(dfEpisodeData, dfFirstPanelist, by='Episode')

dfSecondPanelist <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% filter(AnsweringOrder==2) %>% select(Episode, SecondPanelist = Panelist))
if(dim(dfSecondPanelist)[1] != 0) {
    dfEpisodeData <- left_join(dfEpisodeData, dfSecondPanelist, by='Episode') 
    }

dfThirdPanelist <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% filter(AnsweringOrder==3) %>% select(Episode, ThirdPanelist = Panelist))
if(dim(dfThirdPanelist)[1] != 0) {
    dfEpisodeData <- left_join(dfEpisodeData, dfThirdPanelist, by='Episode') 
    }

dfFourthPanelist <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% filter(AnsweringOrder==4) %>% select(Episode, FourthPanelist = Panelist))
if(dim(dfFourthPanelist)[1] != 0) {
    dfEpisodeData <- left_join(dfEpisodeData, dfFourthPanelist, by='Episode') 
    }

dfFifthPanelist <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% filter(AnsweringOrder==5) %>% select(Episode, FifthPanelist = Panelist))
if(dim(dfFifthPanelist)[1] != 0) {
    dfEpisodeData <- left_join(dfEpisodeData, dfFifthPanelist, by='Episode') 
    }

dfSixthPanelist <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% filter(AnsweringOrder==6) %>% select(Episode, SixthPanelist = Panelist))
#if(dim(dfSixthPanelist)[1] != 0) {
    # dfEpisodeData <- inner_join(dfEpisodeData, dfSixthPanelist, by='Episode') 
#    }

# Append number of panelists for each episode to dfEpisodeData
dfTotalPanelists <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% summarise(TotalPanelists = n()) %>% select(Episode, TotalPanelists))
dfEpisodeData <- inner_join(dfEpisodeData, dfTotalPanelists, by='Episode')



#print(names(dfEpisodeData))
## [1] "Episode"        "Theme"          "FictionItem"    "Host"          
## [5] "CorrectAnswers" "FirstPanelist"  "TotalPanelists"

#head(dfEpisodeData, 2)
##   Episode      Theme FictionItem  Host CorrectAnswers FirstPanelist
## 1     704 Extinction           3 Steve              3          Evan
## 2     705       <NA>           2 Steve              3           Jay
##   TotalPanelists
## 1              4
## 2              4

#names(dfItemsSelected)
## [1] "Episode"        "Panelist"       "ItemSelected"   "AnsweringOrder"
## [5] "FictionItem"    "Theme"          "Correct"

#head(dfItemsSelected, 5)
##Episode Panelist ItemSelected AnsweringOrder FictionItem         Theme
## 1     704     Evan            1              1           3    With Theme
## 2     704      Bob            3              2           3    With Theme
## 3     704     Cara            3              3           3    With Theme
## 4     704      Jay            3              4           3    With Theme
## 5     705      Jay            3              1           2 Without Theme
##   Correct
## 1       0
## 2       1
## 3       1
## 4       1
## 5       0

#names(dfPanelistPerf)
## [1] "Episode"        "AnsweringOrder" "Correct"        "Panelist"      
## [5] "Theme"

#head(dfPanelistPerf, 5)
##   Episode AnsweringOrder Correct Panelist         Theme
## 1     704              1       0     Evan    With Theme
## 2     704              2       1      Bob    With Theme
## 3     704              3       1     Cara    With Theme
## 4     704              4       1      Jay    With Theme
## 5     705              1       0      Jay Without Theme

#names(dfOverallPerf)
## [1] "Episode"        "AnsweringOrder" "Correct"        "Panelist"      
## [5] "Theme"

#head(dfOverallPerf, 5) - includes Rogues and Other Guest Panelists
##   Episode AnsweringOrder Correct Panelist         Theme
## 1     704              1       0     Evan    With Theme
## 2     704              2       1      Bob    With Theme
## 3     704              3       1     Cara    With Theme
## 4     704              4       1      Jay    With Theme
## 5     705              1       0      Jay Without Theme

# Create This Year and Last Year Filtered Dataframes
dfEpisodeData_TY <- dfEpisodeData %>% filter(Episode %in% Episode_range_TY )
dfEpisodeData_LY <- dfEpisodeData %>% filter(Episode %in% Episode_range_LY )

dfItemsSelected_TY <- dfItemsSelected %>% filter(Episode %in% Episode_range_TY )
dfItemsSelected_LY <- dfItemsSelected %>% filter(Episode %in% Episode_range_LY )

dfPanelistPerf_TY <- dfPanelistPerf %>% filter(Episode %in% Episode_range_TY )
dfPanelistPerf_LY <- dfPanelistPerf %>% filter(Episode %in% Episode_range_LY )

dfOverallPerf_TY <- dfOverallPerf %>% filter(Episode %in% Episode_range_TY )
dfOverallPerf_LY <- dfOverallPerf %>% filter(Episode %in% Episode_range_LY )

# Prior Year dataframes
# dfEpisodeData_LY <- readxl::read_excel(pathtofile, sheet = 1 )
# dfEpisodeData_LY <- as.data.frame(dfEpisodeData_LY)
# dfEpisodeData_LY <- select(dfEpisodeData_LY, 1:8) %>% filter(Episode %in% Episode_range_LY)

    
# dfItemsSelected_LY <- readxl::read_excel(pathtofile, sheet =2)
# dfItemsSelected_LY <- as.data.frame(dfItemsSelected_LY)
# dfItemsSelected_LY <- select(dfItemsSelected_LY, c('Episode', 'Panelist', 'ItemSelected', 'AnsweringOrder'))
# dfItemsSelected_LY <- filter(dfItemsSelected_LY, Episode %in% Episode_range_LY)


# dfFictionItems_LY <- select(dfEpisodeData_LY, c('Episode', 'FictionItem', 'Theme'))
# dfItemsSelected_LY <- inner_join(dfItemsSelected_LY, dfFictionItems_LY, by='Episode')
# dfItemsSelected_LY$Correct <- mapply(ifelse, test = (dfItemsSelected_LY$ItemSelected == dfItemsSelected_LY$FictionItem), yes = 1, no = 0 )
# dfItemsSelected_LY$Theme <- mapply(ifelse, test = !is.na(dfItemsSelected_LY$Theme), yes = 'With Theme', no = 'Without Theme')
# dfPanelistPerf_LY <- dfItemsSelected_LY %>% select(Episode, AnsweringOrder, Correct, Panelist, Theme) %>% filter(Panelist %in% Rogues) 
# dfOverallPerf_LY <- dfItemsSelected_LY %>% select(Episode, AnsweringOrder, Correct, Panelist, Theme) # %>% filter(Panelist %in% Rogues)

# Append number correct for each episode
# dfCorrect_LY <- as.data.frame(dfItemsSelected_LY %>% group_by(Episode) %>% summarise(CorrectAnswers = sum(Correct)))
# dfEpisodeData_LY <- inner_join(dfEpisodeData_LY, dfCorrect_LY, by='Episode')

# Append panelist who answered first for each episode
# dfFirstPanelist_LY <- as.data.frame(dfItemsSelected_LY %>% group_by(Episode) %>% filter(AnsweringOrder==1) %>% select(Episode, FirstPanelist = Panelist))
# dfEpisodeData_LY <- inner_join(dfEpisodeData_LY, dfFirstPanelist_LY, by='Episode')

# Append number of panelists for each episode
# dfTotalPanelists_LY <- as.data.frame(dfItemsSelected_LY %>% group_by(Episode) %>% summarise(TotalPanelists = n()) %>% select(Episode, TotalPanelists))
# dfEpisodeData_LY <- inner_join(dfEpisodeData_LY, dfTotalPanelists_LY, by='Episode')


showStatistic <- function(statName, ispercentage = TRUE) {
    myStat <- dfSGUSummary[, statName]
    myStat <- na.exclude(myStat)
    if (ispercentage) {
        myStat2 <- sprintf("%.1f%%", myStat*100)
    }
    else {
        myStat2 <- sprintf("%.0f", myStat)
    }
    names(myStat2) <- names(myStat)
    
    kable(sort(myStat2, decreasing = TRUE), format.args = list(justify='right', width=500) , rownames=TRUE, col.names=NA, digits=2, align = c('l', 'l'), format='html', table.attr = "style='width:15%;'")

}

showStatistic_2 <- function(lstResults, ispercentage = TRUE) {
    
    kable(lstResults, format.args = list(justify='right', width=500) , rownames=TRUE, col.names=NULL, digits=1, align = c('l', 'l'), format='html', table.attr = "style='width:15%;'")

}

```



``` {r Plots_dataprep1, echo = FALSE}
# Overall Performance
winsOverallByPanelist <- dfPanelistPerf_TY %>% group_by(Panelist) %>% summarise(Overall =  sum(Correct)/n(), CorrectGuesses = sum(Correct), TotalGuesses=n())
winsOverallByPanelist <- as.data.frame(winsOverallByPanelist)

winsOverallTotal <- dfOverallPerf_TY %>% summarise(Overall =  sum(Correct)/n(), CorrectGuesses = sum(Correct), TotalGuesses=n())


winsOverallTotal$Panelist ='ALL'
winsOverallTotal <- winsOverallTotal %>% select(Panelist, Overall, CorrectGuesses, TotalGuesses)


winsOverall <- rbind(winsOverallByPanelist, winsOverallTotal) %>% arrange(desc(Overall))


#winsOverall$Overall <- percent(as.numeric(winsOverall$Overall),.1)

panelistLevels = winsOverall$Panelist # Preserve order for second graph
```
``` {r Plots_dataprep2, echo = FALSE}
winsByTheme <- dfPanelistPerf_TY %>% group_by(Panelist, Theme) %>% summarise(pctThemes = sum(Correct)/n(), CorrectGuesses = sum(Correct), TotalGuesses=n())



winsByThemeTotal <- dfOverallPerf_TY %>% group_by(Theme) %>% summarise(pctThemes = sum(Correct)/n(), CorrectGuesses = sum(Correct), TotalGuesses=n()) %>% mutate(Panelist = 'ALL') %>% select(Panelist, Theme, pctThemes, CorrectGuesses, TotalGuesses)


winsByTheme <- as.data.frame(winsByTheme)
winsByThemeTotal <- as.data.frame(winsByThemeTotal)

winsByTheme <- rbind(winsByTheme,winsByThemeTotal) 

#winsByTheme$pctThemes <- percent(as.numeric(winsByTheme$pctThemes),.1)

winsByTheme$Panelist = factor(winsByTheme$Panelist, levels=panelistLevels)

```
``` {r Plots_dataprep_summary1, echo = FALSE}
# Create summary table row for Percent Wins Overall
summary1 <- winsOverall %>% mutate(Result = "% Wins Overall") %>% select(Result, Panelist, Overall) 
names(summary1) <- c("Result", "Panelist", "Statistic")
summary1["Statistic"] <- summary1["Statistic"] * 100
summary1_wide <- dcast(summary1, Result ~ Panelist) %>% select(c('Result', panelistLevels))

summary1a <- winsOverall %>% mutate(Result = "Correct Guesses Overall") %>% select(Result, Panelist, CorrectGuesses) 
names(summary1a) <- c("Result", "Panelist", "Statistic")
summary1a_wide <- dcast(summary1a, Result ~ Panelist) %>% select(c('Result', panelistLevels))

summary1b <- winsOverall %>% mutate(Result = "Total Guesses Overall") %>% select(Result, Panelist, TotalGuesses) 
names(summary1b) <- c("Result", "Panelist", "Statistic")
summary1b_wide <- dcast(summary1b, Result ~ Panelist) %>% select(c('Result', panelistLevels))

summary1 <- summary1 %>% arrange(desc(Statistic))
OverallLeader <- summary1[1,2]
```
``` {r Plots_dataprep_summary2, echo = FALSE}
summary2 <- winsByTheme %>% filter(Theme == "With Theme")
summary2$Theme <- mapply(ifelse, test = (summary2$Theme == "With Theme"), yes = '% Wins With Themes', no = '% Wins Without Themes')
summary2 <- summary2 %>% select(Theme, Panelist, pctThemes)
names(summary2) <- c("Result", "Panelist", "Statistic")
summary2["Statistic"] <- summary2["Statistic"] * 100
summary2_wide <- dcast(summary2, Result ~ Panelist) %>% select(c('Result', panelistLevels))

summary2a <- winsByTheme %>% filter(Theme == "With Theme")
summary2a$Theme <- mapply(ifelse, test = (summary2a$Theme == "With Theme"), yes = 'Correct Guesses with Themes', no = 'Correct Guesses Without Themes')
summary2a <- summary2a %>% select(Theme, Panelist, CorrectGuesses)
names(summary2a) <- c("Result", "Panelist", "Statistic")
summary2a_wide <- dcast(summary2a, Result ~ Panelist) %>% select(c('Result', panelistLevels))

summary2b <- winsByTheme %>% filter(Theme == "With Theme")
summary2b$Theme <- mapply(ifelse, test = (summary2b$Theme == "With Theme"), yes = 'Total Guesses with Themes', no = 'Total Guesses Without Themes')
summary2b <- summary2b %>% select(Theme, Panelist, TotalGuesses)
names(summary2b) <- c("Result", "Panelist", "Statistic")
summary2b_wide <- dcast(summary2b, Result ~ Panelist) %>% select(c('Result', panelistLevels))

summary2 <- summary2 %>% arrange(desc(Statistic))
WithThemeLeader <- summary2[1,2]
```
``` {r Plots_dataprep_summary3, echo = FALSE, message = FALSE}
summary3 <- winsByTheme %>% filter(Theme != "With Theme")
summary3$Theme <- mapply(ifelse, test = (summary3$Theme == "With Theme"), yes = '% Wins With Themes', no = '% Wins Without Themes')
summary3 <- summary3 %>% select(Theme, Panelist, pctThemes)
names(summary3) <- c("Result", "Panelist", "Statistic")
summary3["Statistic"] <- summary3["Statistic"] * 100
summary3_wide <- dcast(summary3, Result ~ Panelist)  
# fill in any missing panelist names in the event that they don't appear
# e.g. Steve hasn't answered a question without a theme
summary3_wide[setdiff(panelistLevels, names(summary3_wide))] <- NA  
summary3_wide <- summary3_wide %>% select(c('Result', panelistLevels))

```
``` {r Plots_dataprep_summary3a, echo = FALSE}
summary3a <- winsByTheme %>% filter(Theme != "With Theme")
summary3a$Theme <- mapply(ifelse, test = (summary3a$Theme == "With Theme"), yes = 'Correct Guesses with Themes', no = 'Correct Guesses Without Themes')
summary3a <- summary3a %>% select(Theme, Panelist, CorrectGuesses)
names(summary3a) <- c("Result", "Panelist", "Statistic")

summary3a_wide <- dcast(summary3a, Result ~ Panelist)  
# fill in any missing panelist names in the event that they don't appear
# e.g. Steve hasn't answered a question without a theme
summary3a_wide[setdiff(panelistLevels, names(summary3a_wide))] <- NA  
summary3a_wide <- summary3a_wide %>% select(c('Result', panelistLevels))

#summary3a_wide <- dcast(summary3a, Result ~ Panelist)  %>% select(c('Result', panelistLevels))
```
``` {r Plots_dataprep_summary3b, echo = FALSE}
summary3b <- winsByTheme %>% filter(Theme != "With Theme")
summary3b$Theme <- mapply(ifelse, test = (summary3b$Theme == "With Theme"), yes = 'Total Guesses with Themes', no = 'Total Guesses Without Themes')
summary3b <- summary3b %>% select(Theme, Panelist, TotalGuesses)
names(summary3b) <- c("Result", "Panelist", "Statistic")

summary3b_wide <- dcast(summary3b, Result ~ Panelist)  
# fill in any missing panelist names in the event that they don't appear
# e.g. Steve hasn't answered a question without a theme
summary3b_wide[setdiff(panelistLevels, names(summary3b_wide))] <- NA  
summary3b_wide <- summary3b_wide %>% select(c('Result', panelistLevels))

summary3 <- summary3 %>% arrange(desc(Statistic))
WithoutThemeLeader = summary3[1,2]

#summary3b_wide <- dcast(summary3b, Result ~ Panelist)  %>% select(c('Result', panelistLevels))
```
``` {r Plots_dataprep_summary_final, echo = FALSE}
summary_final_wide <- rbind(format(summary1_wide, digits = 4), format(summary1a_wide, digits=0), format(summary1b_wide, digits = 0), format(summary2_wide, digits = 4), format(summary2a_wide, digits = 0), format(summary2b_wide, digits = 0), format(summary3_wide, digits=4), format(summary3a_wide, digits=0), format(summary3b_wide, digits=0))
```
``` {r Plots_render, echo = FALSE}
t <- tableGrob(summary_final_wide, rows=NULL, theme = ttheme_default(core=list(fg_params=list(fontface=3L, fontsize=20), bg_params = list(fill = c("#FFFF00", "#FFFF00","#FFFF00","#E69F00", "#E69F00","#E69F00","#56B4E9","#56B4E9","#56B4E9"), col=NA)), colhead=list(fg_params=list(fontface=4L, fontsize=20))) )
#t$widths <- unit(rep(1/ncol(t), ncol(t)), "npc")
t$widths <- unit(c(.25,.125,.125,.125,.125,.125,.125), "npc")
#print(summary_final_wide)
summary_final <- rbind(summary1, summary2, summary3)

summary_final$Panelist = factor(summary_final$Panelist, levels=panelistLevels)
resultLevels = unique(summary_final$Result)
summary_final$Result = factor(summary_final$Result, levels=resultLevels, ordered=TRUE)
summary_final <- as.data.frame(summary_final) 


# should make the titles dynamic
p_final <- ggplot(summary_final, aes(x=Panelist, y=Statistic)) + geom_bar(aes(fill=Result),stat="identity", position = position_dodge(width=.85), color="grey40", width=0.80) + 
    ggtitle(paste(OverallLeader, "Leads Overall \n", WithThemeLeader, "Leads on Segments with Themes \n", WithoutThemeLeader,"Leads on Segments Without Themes")) + 
     # scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
     theme(legend.position = c(.95,1.03), 
           legend.justification = c(1,1), 
           legend.key.size = unit(2, 'lines'), 
           legend.background = element_blank(), 
           text = element_text(size=25),
           plot.title = element_text(hjust = 0.5)) + 
     ylab('% Wins') + xlab('') + 
     scale_fill_manual(values=c("#FFFF00", "#E69F00", "#56B4E9")) + 
     geom_text(aes(group=Result, label=round(Statistic,2)), vjust=2, position = position_dodge(width=.85), size=6) +
     guides(fill=guide_legend(title=""))

lay <- rbind(c(1), c(1), c(1), c(2))

grid.arrange(grobs=list(p_final, t), layout_matrix=lay)
#print(p_final)
#print(t)

print(dfItemsSelected_TY)
print(filter(dfItemsSelected, Episode %in% Mulligan_Episodes) %>% mutate(Correct=1))
```

**NOTE: ALL includes contributions from Special Guest Rogues not listed**  
Raw data and some visuals are located in [This Excel file](https://github.com/wayneheller/SGU_Science_or_Fiction/blob/master/SGU_Science_or_Fiction.xlsx) Click the Download button on this github page.  
Last Year comparison is based on Episodes `r Episode_range_LY [1]` - `r tail(Episode_range_LY ,1)`

``` {r winsOverall_debug, echo = FALSE, eval = debug_flag}
Overall Win Percentage  
showStatistic('% Wins Overall')
```

### Overall Performance
``` {r winsOverall_, echo = FALSE}
# Much of this code will need to be rewrite for 2019 to pull from the same set of data
#  -- This Year Overall ---
statTY <- dfPanelistPerf_TY %>% group_by(Panelist) %>% summarise(Overall =  percent(sum(Correct)/n())) 

totalTY <- dfOverallPerf_TY %>% summarise(Overall =  percent(sum(Correct)/n())) 

statTY <- rbind(statTY,c("ALL", totalTY[1,1])) %>% arrange(desc(Overall))

# --- Last Year Overall ---
statLY <- dfPanelistPerf_LY %>% group_by(Panelist) %>% summarise(Overall =  percent(sum(Correct)/n())) 

totalLY <- dfOverallPerf_LY %>% summarise(Overall =  percent(sum(Correct)/n())) 

statLY <- rbind(statLY,c("ALL", totalLY[1,1])) %>% arrange(desc(Overall))


# All of this code is to pull from the Excel Summary for 2017
# statName <- '% Wins Overall'
# statLY <- dfSGUSummary[, statName]
# statLY <- na.exclude(statLY)
# statLY2 <- sprintf("%.1f%%", statLY*100)
# names(statLY2) <- names(statLY)
# dfstatLY2 <- as.data.frame(statLY2)
# dfstatLY2<- cbind(Panelist = rownames(dfstatLY2), dfstatLY2)
# rownames(dfstatLY2) <- NULL


statYoY <- merge(statTY, statLY, by = 'Panelist') 

names(statYoY) <- c('Panelist', Current_Year, Last_Year)

kable(statYoY, format.args = list(justify='right', width=500) , rownames=TRUE,  digits=1, align = c('l', 'c', 'c'), format='html', table.attr = "style='width:25%;'")

#showStatistic_2(stat)
```

### Performance For Segments WITH Themes
``` {r winsThemes_debug, echo = FALSE, eval = debug_flag}

showStatistic('% Wins with Themes')
```

``` {r winsThemes, echo = FALSE}
# --- Wins with Themes This Year --
statTY <- dfPanelistPerf_TY %>% group_by(Panelist) %>% filter(Episode %in% dfEpisodeData_TY[!is.na(dfEpisodeData_TY$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
totalTY <- dfOverallPerf_TY %>% filter(Episode %in% dfEpisodeData_TY[!is.na(dfEpisodeData_TY$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
statTY <- rbind(statTY,c("ALL", totalTY[1,1])) %>% arrange(desc(pctThemes))

# --- Wins with Themes Last Year --
statLY <- dfPanelistPerf_LY %>% group_by(Panelist) %>% filter(Episode %in% dfEpisodeData_LY[!is.na(dfEpisodeData_LY$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
totalLY <- dfOverallPerf_LY %>% filter(Episode %in% dfEpisodeData_LY[!is.na(dfEpisodeData_LY$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
statLY <- rbind(statLY,c("ALL", totalLY[1,1])) %>% arrange(desc(pctThemes))

# All of this code is to pull from the Excel Summary for 2017
# statName <- '% Wins with Themes'
# statLY <- dfSGUSummary[, statName]
# statLY <- na.exclude(statLY)
# statLY2 <- sprintf("%.1f%%", statLY*100)
# names(statLY2) <- names(statLY)
# dfstatLY2 <- as.data.frame(statLY2)
# dfstatLY2<- cbind(Panelist = rownames(dfstatLY2), dfstatLY2)
# rownames(dfstatLY2) <- NULL


statYoY <- merge(statTY, statLY, by = 'Panelist') 

names(statYoY) <- c('Panelist', Current_Year, Last_Year)

kable(statYoY, format.args = list(justify='right', width=500) , rownames=TRUE,  digits=1, align = c('l', 'c', 'c'), format='html', table.attr = "style='width:25%;'")

#showStatistic_2(stat)
```

### Performance For Segments WITHOUT Themes
``` {r winswithoutThemes_debug, echo = FALSE, eval = debug_flag}
Win Percentage For Segments WITHOUT Themes
showStatistic('% Wins without Themes')
```

``` {r winswithoutThemes, echo = FALSE}
# --- Wins without Themes This Year ---

statTY <- dfPanelistPerf_TY %>% group_by(Panelist) %>% filter(Episode %in% dfEpisodeData_TY[is.na(dfEpisodeData_TY$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n()))
totalTY <- dfOverallPerf_TY %>% filter(Episode %in% dfEpisodeData_TY[is.na(dfEpisodeData_TY$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
statTY <- rbind(statTY,c("ALL", totalTY[1,1])) %>% arrange(desc(pctThemes))

# --- Wins without Themes Last Year ---
statLY <- dfPanelistPerf_LY %>% group_by(Panelist) %>% filter(Episode %in% dfEpisodeData_LY[is.na(dfEpisodeData_LY$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n()))
totalLY <- dfOverallPerf_LY %>% filter(Episode %in% dfEpisodeData_LY[is.na(dfEpisodeData_LY$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
statLY <- rbind(statLY,c("ALL", totalLY[1,1])) %>% arrange(desc(pctThemes))


# All of this code is to pull from the Excel Summary for 2017
# statName <- '% Wins without Themes'
# statLY <- dfSGUSummary[, statName]
# statLY <- na.exclude(statLY)
# statLY2 <- sprintf("%.1f%%", statLY*100)
# names(statLY2) <- names(statLY)
# dfstatLY2 <- as.data.frame(statLY2)
# dfstatLY2<- cbind(Panelist = rownames(dfstatLY2), dfstatLY2)
# rownames(dfstatLY2) <- NULL


statYoY <- merge(statTY, statLY, by = 'Panelist') 
names(statYoY) <- c('Panelist', Current_Year, Last_Year)

kable(statYoY, format.args = list(justify='right', width=500) , rownames=TRUE,  digits=1, align = c('l', 'c', 'c'), format='html', table.attr = "style='width:25%;'")

#showStatistic_2(stat)
```

### Solo Wins
``` {r SoloWins_debug, echo = FALSE, eval = debug_flag}
showStatistic('Solo Wins', ispercentage = FALSE)
```

``` {r SoloWins, echo = FALSE}
dfSoloWins <- dfItemsSelected_TY[dfItemsSelected_TY$Episode %in% dfEpisodeData_TY[dfEpisodeData_TY$CorrectAnswers==1, 'Episode'] & dfItemsSelected_TY$Correct==1, c('Episode', 'Panelist')]
stat <- dfSoloWins %>% group_by(Panelist) %>% summarise(SoloWins = n()) %>% arrange(desc(SoloWins))
total <- dfSoloWins  %>% summarise(SoloWins = n()) 
stat <- rbind(stat,c("TOTAL", total[1,1])) 
showStatistic_2(stat)
```

### Longest Consecutive Winning Streak
``` {r WinStreak_debug, echo = FALSE, eval = debug_flag}
showStatistic('Longest Winning Streak', ispercentage = FALSE)
```

``` {r WinStreak, echo = FALSE}
wins = list()
losses = list()
for (rogue in Rogues) {
    df <- dfItemsSelected_TY %>% filter(Panelist == rogue)
    x = rle(df$Correct)
    wins[rogue] = max(x$lengths[x$values == 1])
    losses[rogue] = max(x$lengths[x$values == 0])
}
wins <- wins[order(unlist(wins),decreasing=TRUE)]
wins <- wins[wins >= 0]
stat <- t(as.data.frame(wins))

showStatistic_2(stat)
```

### Longest Consecutive Losing Streak
``` {r LoseStreak_debug, echo = FALSE, eval = debug_flag}
showStatistic('Longest Losing Streak', ispercentage = FALSE)
```
``` {r LoseStreak, echo = FALSE}
losses <- losses[order(unlist(losses),decreasing=TRUE)]
losses <- losses[losses >= 0]
stat <- t(as.data.frame(losses))
showStatistic_2(stat)
```

### Panel Performance When Answering First
#### A measure of how well the panel of rogues perform based on who answers first

``` {r PanelPerformance_debug, echo = FALSE, eval = debug_flag}
showStatistic('Panel Performance When Answering First')
```
``` {r PanelPerformance, echo = FALSE}
statTY <- dfEpisodeData_TY %>% filter(FirstPanelist %in% Rogues) %>% group_by(FirstPanelist) %>% summarise(PanelPerformance = percent(sum(CorrectAnswers)/sum(TotalPanelists))) %>% arrange(desc(PanelPerformance))

statLY <- dfEpisodeData_LY %>% filter(FirstPanelist %in% Rogues) %>% group_by(FirstPanelist) %>% summarise(PanelPerformance = percent(sum(CorrectAnswers)/sum(TotalPanelists))) %>% arrange(desc(PanelPerformance))
names(statTY) <- c('Panelist', 'PanelPerformance')

#showStatistic_2(statTY)

# All of this code is to pull from the Excel Summary for 2017
# statName <- 'Panel Performance When Answering First'
# statLY <- dfSGUSummary[, statName]
# statLY <- na.exclude(statLY)
# statLY2 <- sprintf("%.1f%%", statLY*100)
# names(statLY2) <- names(statLY)
# dfstatLY2 <- as.data.frame(statLY2)
# dfstatLY2<- cbind(Panelist = rownames(dfstatLY2), dfstatLY2)
# rownames(dfstatLY2) <- NULL
#showStatistic_2(statLY2)

names(statLY) <- c('Panelist', 'PanelPerformance')
statYoY <- merge(statTY, statLY, by = 'Panelist') 

names(statYoY) <- c('Panelist', Current_Year, Last_Year)

statYoY <- statYoY %>% arrange(desc(`2020`))
kable(statYoY, format.args = list(justify='right', width=500) , rownames=TRUE,  digits=1, align = c('l', 'c', 'c'), format='html', table.attr = "style='width:25%;'")
```

### Individual Panelist Performance When Answering First
#### A measure of an individuals performance when answering first
``` {r PanelistPerformance_debug, echo = FALSE, eval = debug_flag}
showStatistic('Panelist Performance When Answering First')
```
``` {r PanelistPerformance, echo = FALSE}
stat <- dfPanelistPerf_TY %>% group_by(Panelist) %>% filter(AnsweringOrder==1) %>% summarise(pctAnsweringFirst = percent(sum(Correct)/n())) %>% arrange(desc(pctAnsweringFirst))
total <- dfOverallPerf_TY %>% filter(AnsweringOrder==1) %>% summarise(pctAnsweringFirst = percent(sum(Correct)/n())) %>% arrange(desc(pctAnsweringFirst))
statTY <- rbind(stat,c("ALL", total[1,1])) %>% arrange(desc(pctAnsweringFirst))
names(statTY) <- c('Panelist', 'PanelPerformance')

stat <- dfPanelistPerf_LY %>% group_by(Panelist) %>% filter(AnsweringOrder==1) %>% summarise(pctAnsweringFirst = percent(sum(Correct)/n())) %>% arrange(desc(pctAnsweringFirst))
total <- dfOverallPerf_LY %>% filter(AnsweringOrder==1) %>% summarise(pctAnsweringFirst = percent(sum(Correct)/n())) %>% arrange(desc(pctAnsweringFirst))
statLY <- rbind(stat,c("ALL", total[1,1])) %>% arrange(desc(pctAnsweringFirst))
names(statLY) <- c('Panelist', 'PanelPerformance')
#showStatistic_2(statTY)

# All of this code is to pull from the Excel Summary for 2017
#statName <- 'Panelist Performance When Answering First'
#statLY <- dfSGUSummary[, statName]
#statLY <- na.exclude(statLY)
#statLY2 <- sprintf("%.1f%%", statLY*100)
#names(statLY2) <- names(statLY)
#dfstatLY2 <- as.data.frame(statLY2)
#dfstatLY2<- cbind(Panelist = rownames(dfstatLY2), dfstatLY2)
#rownames(dfstatLY2) <- NULL
#showStatistic_2(statLY2)
statYoY <- merge(statTY, statLY, by = 'Panelist') 
names(statYoY) <- c('Panelist', Current_Year, Last_Year)
statYoY <- statYoY %>% arrange(desc(`2020`))
kable(statYoY, format.args = list(justify='right', width=500) , rownames=TRUE,  digits=1, align = c('l', 'c', 'c'), format='html', table.attr = "style='width:25%;'")
```

### Host Sweeps
``` {r HostSweeps_debug, echo = FALSE, eval = debug_flag}
showStatistic('Host Sweeps', ispercentage = FALSE)
```

``` {r HostSweeps, echo = FALSE}
dfHostSweeps <- dfEpisodeData_TY[dfEpisodeData_TY$CorrectAnswers==0, c('Episode', 'Host')]
stat <- dfHostSweeps %>% group_by(Host) %>% summarize(HostSweeps = n()) %>% arrange(desc(HostSweeps))
total <- dfHostSweeps %>% summarize(HostSweeps = n())
statTY <- rbind(stat,c("ALL", total[1,1])) 
#showStatistic_2(statTY)
dfHostSweeps <- dfEpisodeData_LY[dfEpisodeData_LY$CorrectAnswers==0, c('Episode', 'Host')]
stat <- dfHostSweeps %>% group_by(Host) %>% summarize(HostSweeps = n()) %>% arrange(desc(HostSweeps))
total <- dfHostSweeps %>% summarize(HostSweeps = n())
statLY <- rbind(stat,c("ALL", total[1,1])) 
# All of this code is to pull from the Excel Summary for 2017
#statName <- 'Host Sweeps'
#statLY <- dfSGUSummary[, statName]
#statLY2 <- na.exclude(statLY)
#statLY2 <- sprintf("%.1f%%", statLY*100)
#names(statLY2) <- names(statLY)
#dfstatLY2 <- as.data.frame(statLY2)
#dfstatLY2<- cbind(Panelist = rownames(dfstatLY2), dfstatLY2)
#print(dfstatLY2)
#dfstatLY2 <- dfstatLY2 %>% filter(statLY2 > 0)
#rownames(dfstatLY2) <- NULL

#showStatistic_2(statLY2)

names(statTY) <- c('Panelist', 'PanelPerformance')
names(statLY) <- c('Panelist', 'PanelPerformance')
statYoY <- merge(statTY, statLY, by = 'Panelist', all = TRUE) 

names(statYoY) <- c('Host', Current_Year, Last_Year)

statYoY <- statYoY %>% arrange(desc(`2020`))
kable(statYoY, format.args = list(justify='right', width=500) , rownames=TRUE,  digits=1, align = c('l', 'c', 'c'), format='html', table.attr = "style='width:25%;'")
```

### Panelist Sweeps
#### How many times a panelist has participated in a sweep of the host
``` {r PanelSweeps_debug, echo = FALSE, eval = debug_flag}
showStatistic('Panelist Sweeps', ispercentage = FALSE)
```

``` {r PanelSweeps, echo = FALSE}
statTY <- dfItemsSelected_TY[dfItemsSelected_TY$Episode %in% dfEpisodeData_TY[dfEpisodeData_TY$CorrectAnswers == dfEpisodeData_TY$TotalPanelists,"Episode"],] %>% group_by(Panelist) %>% summarise(PanelistSweeps = n()) %>% filter(Panelist %in% Rogues) %>% arrange(desc(PanelistSweeps))
#showStatistic_2(statTY)
statLY <- dfItemsSelected_LY[dfItemsSelected_LY$Episode %in% dfEpisodeData_LY[dfEpisodeData_LY$CorrectAnswers == dfEpisodeData_LY$TotalPanelists,"Episode"],] %>% group_by(Panelist) %>% summarise(PanelistSweeps = n()) %>% filter(Panelist %in% Rogues) %>% arrange(desc(PanelistSweeps))

# All of this code is to pull from the Excel Summary for 2017
#statName <- 'Panelist Sweeps'
#statLY <- dfSGUSummary[, statName]
#statLY2 <- na.exclude(statLY)
#statLY2 <- sprintf("%.1f%%", statLY*100)
#names(statLY2) <- names(statLY)
#dfstatLY2 <- as.data.frame(statLY2)
#dfstatLY2<- cbind(Panelist = rownames(dfstatLY2), dfstatLY2)
#rownames(dfstatLY2) <- NULL
#showStatistic_2(statLY2)

names(statTY) <- c('Panelist', 'PanelPerformance')
names(statLY) <- c('Panelist', 'PanelPerformance')
statYoY <- merge(statTY, statLY, by = 'Panelist') 

names(statYoY) <- c('Panelist', Current_Year, Last_Year)

statYoY <- statYoY %>% arrange(desc(`2020`))
kable(statYoY, format.args = list(justify='right', width=500) , rownames=TRUE,  digits=1, align = c('l', 'c', 'c'), format='html', table.attr = "style='width:25%;'")
```


``` {r DuoPerformance_1, echo = FALSE}
    dfDuoPerf <- inner_join(dfItemsSelected_TY, dfItemsSelected_TY, by='Episode')
    
    dfDuo <- dfDuoPerf %>% filter(Panelist.x %in% Rogues) %>% filter(Panelist.y %in% Rogues) %>% group_by(Panelist.x, Panelist.y, ItemSelected.x == ItemSelected.y) %>% summarise('Percent Correct' = percent(sum(Correct.x)/n()))
   
    dfDuo <-  rename(dfDuo, Rogue = Panelist.x) 
    dfDuo <-  rename(dfDuo, Peer = Panelist.y)
    dfDuo <-  rename(dfDuo, Agree = 'ItemSelected.x == ItemSelected.y')

    dfDuoWide <- dfDuo %>% filter(Agree==FALSE) %>% dcast( Rogue ~ Peer , value.var ='Percent Correct')
    
    pctCaraBob <- dfDuo %>% filter(Rogue == 'Cara' & Peer =='Bob' & Agree == FALSE) 
    pctBobCara <- dfDuo %>% filter(Rogue == 'Bob' & Peer =='Cara' & Agree == FALSE) 

```

### Duo Performance
#### How well each pair of rouges performs when choosing a DIFFERENT answer from their peer
For example, when Cara answers differently from Bob, she is correct `r pctCaraBob['Percent Correct']` of the time.  
When Bob answers differently from Cara, he is correct `r pctBobCara['Percent Correct']` of the time.

``` {r DuoPerformance_2, echo = FALSE}
    kable(dfDuoWide, format.args = list(justify='right', width=500) , rownames=TRUE, digits=1, align = c('l', 'c', 'c','c','c','c'), format='html', table.attr = "style='width:35%;'")

    dfDuoWide <- dfDuo %>% filter(Agree==TRUE) %>% dcast( Rogue ~ Peer , value.var ='Percent Correct')
    
    pctJayEvan <- dfDuo %>% filter(Rogue == 'Jay' & Peer =='Evan' & Agree == TRUE) 
```

#### How well each pair of rouges performs when choosing the SAME answer as their peer
For example, when Jay and Evan pick the same answer they are correct `r pctJayEvan['Percent Correct']` of the time.  
Note: Numbers along the diagonal are the same as individual performance for the year.  

``` {r DuoPerformance_3, echo = FALSE}
    kable(dfDuoWide, format.args = list(justify='right', width=500) , rownames=TRUE, digits=1, align = c('l', 'c', 'c','c','c','c'), format='html', table.attr = "style='width:35%;'")



```
#### How Well Each Answering Order Combination Has Performed Since 2018
For each combination, the number of times this combination has occurred (frequency), the total correct answers, total possible answers, and the accuracy percentage (correct/possible) is listed below.

##### Answering Order Combinations with Frequency >= 3
``` {r AnsweringOrderFiltered, echo = FALSE}
dfEpisodeData$PanelistSweep <- mapply(ifelse, test = (dfEpisodeData$CorrectAnswers == dfEpisodeData$TotalPanelists), yes = 1, no = 0 )
dfEpisodeData$HostSweep <- mapply(ifelse, test = (dfEpisodeData$CorrectAnswers == 0), yes = 1, no = 0 )

dfAnsweringOrderPerf <- dfEpisodeData%>% group_by(FirstPanelist, SecondPanelist, ThirdPanelist, FourthPanelist, FifthPanelist)  %>% summarise(Occurred = sum(n()), TotalCorrect = sum(CorrectAnswers), TotalAnswers = sum(TotalPanelists), TotalPanelistSweeps = sum(PanelistSweep), TotalHostSweeps = sum(HostSweep), PercentCorrect = TotalCorrect / TotalAnswers * 100) %>% arrange(desc(PercentCorrect), desc(Occurred))

names(dfAnsweringOrderPerf) <- c('First', 'Second', 'Third', 'Fourth', 'Fifth', 'Frequency', 'Correct', 'Possible','PanelistSweeps', 'HostSweeps', 'Accuracy(%)')
kable(dfAnsweringOrderPerf %>% filter(Frequency >=3), format.args = list(justify='right', width=1000) , rownames=FALSE, digits=1, align = c('l', 'l', 'l','l','l','c','c','c','c', 'c', 'r'),format='html',table.attr = "style='width:100%;'")
```
##### Answering Order Combinations Full Detail
``` {r AnsweringOrderUnfiltered, echo = FALSE}
kable(dfAnsweringOrderPerf, format.args = list(justify='right', width=1000) , rownames=FALSE, digits=1, align = c('l', 'l', 'l','l','l','c','c','c','c', 'c', 'r'),format='html',table.attr = "style='width:100%;'")
```

