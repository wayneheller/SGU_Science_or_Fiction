---
title: "SGU 2018 Science or Fiction Stats"
author: "Wayne Heller"
date: "September 8, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 18, fig.height = 14)
```

``` {r loaddata, echo=FALSE}
library(readxl)
library(dplyr)
library(reshape2)
library(knitr)
library(scales)
library(ggplot2)
library(gridExtra)
library(forcats)

debug_flag = FALSE # See description below.  If TRUE, will show the summarization values
Episode_range = 652:687
```

## Background
The Skeptics Guide to the Universe is a weekly podcast hosted by Dr. Steven Novella.  Each week during this segment of the podcast, Dr. Novella presents his panel of skeptics with 3 or 4 science-related news items, 1 of which is fiction.  And each panelist must determine which is the fiction.

## Year End Episode
At the end of the calendar year, Dr. Novella host a year in review episode where the panel reviews their performance at Science or Fiction.  

## 2018 Summary Facts - Episodes# `r Episode_range[1]` - `r tail(Episode_range,1)`
###(Beginning of the Calendar Year Through DragonCon)

* Evan is in the lead this year with the highest overall win percentage, followed by Cara  
* Evan has the most solo wins, followed by Cara.
* Bob's perception that segments with themes are harder isn't true overall but is true for him  
* Cara's performance is much better on segments with themes than without. 
* The panel performs better overall when Cara answers first 
* Relative to other panelists, Bob does well when he is the first to answer.
* There have been 9 panelist sweeps to date (compared to 7 in all of 2017) and 3 hosts sweeps, 1 by Bob and 2 by Steve (Steve had 5 host sweeps last year).    

## 2018 Summary Statistics - Episodes# `r Episode_range[1]` - `r tail(Episode_range,1)` 
**NOTE: ALL includes contributions from Special Guest Rogues not listed**  
Raw data and some visuals are located in [This Excel file](https://github.com/wayneheller/SGU_Science_or_Fiction/blob/master/SGU_Science_or_Fiction.xlsx) Click the Download button on this github page.  

``` {r readstats, echo = FALSE}
# This code has evolved over time, in the first iteration, markdown was simply used to read summary values from the source data
# in Excel and present it on an HTML page published to RPubs.com.  In the next version, the Excel file was modified to put the
# panelist answers on a separate tab in tidy format.  The revised markdown reads the data and does the summarization.  Since
# both versions exist in the same Excel file, this code is able to create a markdown file that shows both, the summary from Excel
# and the calculated summarizations.  Setting the debug_flag to TRUE enables both versions to be shown

pathtofile <- file.path("..",'SGU_Science_or_Fiction.xlsx')
Rogues <- c("Steve", "Bob", "Evan", "Cara", "Jay")



if (debug_flag == TRUE) {
    dfSGUSummary <- readxl::read_excel(pathtofile, sheet = 5 )
    dfSGUSummary <- as.data.frame(dfSGUSummary)
    rownames(dfSGUSummary) <- dfSGUSummary$Statistic
    dfSGUSummary <- select(dfSGUSummary, -Statistic)
    
    dfSGUSummary <- select(dfSGUSummary, c(Rogues, "ALL"))
    dfSGUSummary <- t(dfSGUSummary)
}


dfEpisodeData <- readxl::read_excel(pathtofile, sheet = 1 )
dfEpisodeData <- as.data.frame(dfEpisodeData)
dfEpisodeData <- select(dfEpisodeData, 1:8) %>% filter(Episode %in% Episode_range)
    
    
dfItemsSelected <- readxl::read_excel(pathtofile, sheet =2)
dfItemsSelected <- as.data.frame(dfItemsSelected)
dfItemsSelected <- select(dfItemsSelected, c('Episode', 'Panelist', 'ItemSelected', 'AnsweringOrder'))
dfItemsSelected <- filter(dfItemsSelected, Episode %in% Episode_range)
    

dfFictionItems <- select(dfEpisodeData, c('Episode', 'FictionItem', 'Theme'))
dfItemsSelected <- inner_join(dfItemsSelected, dfFictionItems, by='Episode')
dfItemsSelected$Correct <- mapply(ifelse, test = (dfItemsSelected$ItemSelected == dfItemsSelected$FictionItem), yes = 1, no = 0 )
dfItemsSelected$Theme <- mapply(ifelse, test = !is.na(dfItemsSelected$Theme), yes = 'With Theme', no = 'Without Theme')
dfPanelistPerf <- dfItemsSelected %>% select(Episode, AnsweringOrder, Correct, Panelist, Theme) %>% filter(Panelist %in% Rogues) 
dfOverallPerf <- dfItemsSelected %>% select(Episode, AnsweringOrder, Correct, Panelist, Theme) # %>% filter(Panelist %in% Rogues)

# Append number correct for each episode
dfCorrect <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% summarise(CorrectAnswers = sum(Correct)))
dfEpisodeData <- inner_join(dfEpisodeData, dfCorrect, by='Episode')

# Append panelist who answered first for each episode
dfFirstPanelist <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% filter(AnsweringOrder==1) %>% select(Episode, FirstPanelist = Panelist))
dfEpisodeData <- inner_join(dfEpisodeData, dfFirstPanelist, by='Episode')

# Append number of panelists for each episode
dfTotalPanelists <- as.data.frame(dfItemsSelected %>% group_by(Episode) %>% summarise(TotalPanelists = n()) %>% select(Episode, TotalPanelists))
dfEpisodeData <- inner_join(dfEpisodeData, dfTotalPanelists, by='Episode')


showStatistic <- function(statName, ispercentage = TRUE) {
    myStat <- dfSGUSummary[, statName]
    myStat <- na.exclude(myStat)
    if (ispercentage) {
        myStat2 <- sprintf("%.1f%%", myStat*100)
    }
    else {
        myStat2 <- sprintf("%.0f", myStat)
    }
    names(myStat2) <- names(myStat)
    
    kable(sort(myStat2, decreasing = TRUE), format.args = list(justify='right', width=500) , rownames=TRUE, col.names=NA, digits=2, align = c('l', 'l'), format='html', table.attr = "style='width:15%;'")

}

showStatistic_2 <- function(lstResults, ispercentage = TRUE) {
    
    kable(lstResults, format.args = list(justify='right', width=500) , rownames=TRUE, col.names=NULL, digits=1, align = c('l', 'l'), format='html', table.attr = "style='width:15%;'")

}

```

### Overall Win Percentage

``` {r winsOverall_debug, echo = FALSE, eval = debug_flag}
showStatistic('% Wins Overall')
```


``` {r winsOverall, echo = FALSE}
# Overall Performance
stat <- dfPanelistPerf %>% group_by(Panelist) %>% summarise(Overall =  percent(sum(Correct)/n())) 
total <- dfOverallPerf %>% summarise(Overall =  percent(sum(Correct)/n())) 
stat <- rbind(stat,c("ALL", total[1,1])) %>% arrange(desc(Overall))
showStatistic_2(stat)
```

### Win Percentage For Segments WITH Themes
``` {r winsThemes_debug, echo = FALSE, eval = debug_flag}
showStatistic('% Wins with Themes')
```

``` {r winsThemes, echo = FALSE}
stat <- dfPanelistPerf %>% group_by(Panelist) %>% filter(Episode %in% dfEpisodeData[!is.na(dfEpisodeData$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
total <- dfOverallPerf %>% filter(Episode %in% dfEpisodeData[!is.na(dfEpisodeData$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
stat <- rbind(stat,c("ALL", total[1,1])) %>% arrange(desc(pctThemes))
showStatistic_2(stat)
```

### Win Percentage For Segments WITHOUT Themes
``` {r winswithoutThemes_debug, echo = FALSE, eval = debug_flag}
showStatistic('% Wins without Themes')
```

``` {r winswithoutThemes, echo = FALSE}
stat <- dfPanelistPerf %>% group_by(Panelist) %>% filter(Episode %in% dfEpisodeData[is.na(dfEpisodeData$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n()))
total <- dfOverallPerf %>% filter(Episode %in% dfEpisodeData[is.na(dfEpisodeData$Theme), 'Episode']) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
stat <- rbind(stat,c("ALL", total[1,1])) %>% arrange(desc(pctThemes))
showStatistic_2(stat)
```

### Solo Wins
``` {r SoloWins_debug, echo = FALSE, eval = debug_flag}
showStatistic('Solo Wins', ispercentage = FALSE)
```

``` {r SoloWins, echo = FALSE}
dfSoloWins <- dfItemsSelected[dfItemsSelected$Episode %in% dfEpisodeData[dfEpisodeData$CorrectAnswers==1, 'Episode'] & dfItemsSelected$Correct==1, c('Episode', 'Panelist')]
stat <- dfSoloWins %>% group_by(Panelist) %>% summarise(SoloWins = n()) %>% arrange(desc(SoloWins))
total <- dfSoloWins  %>% summarise(SoloWins = n()) 
stat <- rbind(stat,c("TOTAL", total[1,1])) 
showStatistic_2(stat)
```

### Longest Consecutive Winning Streak
``` {r WinStreak_debug, echo = FALSE, eval = debug_flag}
showStatistic('Longest Winning Streak', ispercentage = FALSE)
```

``` {r WinStreak, echo = FALSE}
wins = list()
losses = list()
for (rogue in Rogues) {
    df <- dfItemsSelected %>% filter(Panelist == rogue)
    x = rle(df$Correct)
    wins[rogue] = max(x$lengths[x$values == 1])
    losses[rogue] = max(x$lengths[x$values == 0])
}
wins <- wins[order(unlist(wins),decreasing=TRUE)]
wins <- wins[wins >= 0]
stat <- t(as.data.frame(wins))

showStatistic_2(stat)
```

### Longest Consecutive Losing Streak
``` {r LoseStreak_debug, echo = FALSE, eval = debug_flag}
showStatistic('Longest Losing Streak', ispercentage = FALSE)
```
``` {r LoseStreak, echo = FALSE}
losses <- losses[order(unlist(losses),decreasing=TRUE)]
losses <- losses[losses >= 0]
stat <- t(as.data.frame(losses))
showStatistic_2(stat)
```

### Panel Performance When Answering First
#### A measure of how well the other rogues perform based on who answers first

``` {r PanelPerformance_debug, echo = FALSE, eval = debug_flag}
showStatistic('Panel Performance When Answering First')
```
``` {r PanelPerformance, echo = FALSE}
stat <- dfEpisodeData %>% filter(FirstPanelist %in% Rogues) %>% group_by(FirstPanelist) %>% summarise(PanelPerformance = percent(sum(CorrectAnswers)/sum(TotalPanelists))) %>% arrange(desc(PanelPerformance))
showStatistic_2(stat)
```

### Individual Panelist Performance When Answering First
#### A measure of an individuals performance when answering first
``` {r PanelistPerformance_debug, echo = FALSE, eval = debug_flag}
showStatistic('Panelist Performance When Answering First')
```
``` {r PanelistPerformance, echo = FALSE}
stat <- dfPanelistPerf %>% group_by(Panelist) %>% filter(AnsweringOrder==1) %>% summarise(pctAnsweringFirst = percent(sum(Correct)/n())) %>% arrange(desc(pctAnsweringFirst))
total <- dfOverallPerf %>% filter(AnsweringOrder==1) %>% summarise(pctAnsweringFirst = percent(sum(Correct)/n())) %>% arrange(desc(pctAnsweringFirst))
stat <- rbind(stat,c("ALL", total[1,1])) %>% arrange(desc(pctAnsweringFirst))
showStatistic_2(stat)
```

### Host Sweeps
``` {r HostSweeps_debug, echo = FALSE, eval = debug_flag}
showStatistic('Host Sweeps', ispercentage = FALSE)
```

``` {r HostSweeps, echo = FALSE}
dfHostSweeps <- dfEpisodeData[dfEpisodeData$CorrectAnswers==0, c('Episode', 'Host')]
stat <- dfHostSweeps %>% group_by(Host) %>% summarize(HostSweeps = n()) %>% arrange(desc(HostSweeps))
total <- dfHostSweeps %>% summarize(HostSweeps = n())
stat <- rbind(stat,c("TOTAL", total[1,1])) 
showStatistic_2(stat)
```

### Panelist Sweeps
#### How many times a panelist has participated in a sweep of the host
``` {r PanelSweeps_debug, echo = FALSE, eval = debug_flag}
showStatistic('Panelist Sweeps', ispercentage = FALSE)
```

``` {r PanelSweeps, echo = FALSE}
stat <- dfItemsSelected[dfItemsSelected$Episode %in% dfEpisodeData[dfEpisodeData$CorrectAnswers == dfEpisodeData$TotalPanelists,"Episode"],] %>% group_by(Panelist) %>% summarise(PanelistSweeps = n()) %>% arrange(desc(PanelistSweeps))
showStatistic_2(stat)
```

## Visuals
``` {r Plots, echo = FALSE}
# Overall Performance
stat1 <- dfPanelistPerf %>% group_by(Panelist) %>% summarise(Overall =  percent(sum(Correct)/n())) 
total1 <- dfOverallPerf %>% summarise(Overall =  percent(sum(Correct)/n())) 
stat1 <- rbind(stat1,c("ALL", total1[1,1])) %>% arrange(desc(Overall))

#p1 <- ggplot(stat1, aes(x=reorder(Panelist, desc(Overall)), y=Overall)) + geom_bar(stat="identity", width=0.5) + ggtitle("Science or Fiction 2018 Results") + theme(text = element_text(size=20)) + ylab('% Wins Overall') + xlab('')

panelistLevels = stat1$Panelist # Preserve order for second graph

stat2 <- dfPanelistPerf %>% group_by(Panelist, Theme) %>% summarise(pctThemes = percent(sum(Correct)/n())) 
total2 <- dfOverallPerf %>% group_by(Theme) %>% summarise(pctThemes = percent(sum(Correct)/n())) %>% mutate(Panelist = 'ALL') %>% select(Panelist, Theme, pctThemes)
stat2 <- as.data.frame(stat2)
total2 <- as.data.frame(total2)
stat2 <- rbind(stat2,total2) 


stat2$Panelist = factor(stat2$Panelist, levels=panelistLevels)


#p2 <- ggplot(stat2, aes(x=Panelist, y=pctThemes, fill=Theme)) + geom_bar(stat="identity", position = position_dodge(width=.75), color="grey40", width=0.75) + ggtitle("Science or Fiction 2018 Results") + theme(legend.position = c(.85,1), legend.justification = c(1,1), legend.background = element_blank(), text = element_text(size=20) ) + ylab('% Wins Themes / No Themes') + xlab('')




summary1 <- stat1 %>% mutate(Result = "% Wins Overall") %>% select(Result, Panelist, Overall) 
names(summary1) <- c("Result", "Panelist", "Pct")
summary1_wide <- dcast(summary1, Result ~ Panelist) %>% select(c('Result', panelistLevels))

summary2 <- stat2 
summary2$Theme <- mapply(ifelse, test = (summary2$Theme == "With Theme"), yes = '% Wins With Themes', no = '% Wins Without Themes')
summary2 <- summary2 %>% select(Theme, Panelist, pctThemes)
names(summary2) <- c("Result", "Panelist", "Pct")
summary2_wide <- dcast(summary2, Result ~ Panelist) %>% select(c('Result', panelistLevels))
summary_final_wide <- rbind(summary1_wide, summary2_wide)

#k <- kable(summary_final, format.args = list(justify='right', width=500) ,row.names=NA, digits=1, format='html', table.attr = "style='width:90%;'")

#tt1 <- ttheme_default()
t <- tableGrob(summary_final_wide, rows=NULL, theme = ttheme_default(core=list(fg_params=list(fontface=3L, fontsize=20), bg_params = list(fill = c("#FFFF00", "#E69F00", "#56B4E9"), col=NA)), colhead=list(fg_params=list(fontface=4L, fontsize=20))) )
t$widths <- unit(rep(1/ncol(t), ncol(t)), "npc")

summary_final <- rbind(summary1, summary2)
summary_final$Panelist = factor(summary_final$Panelist, levels=panelistLevels)
resultLevels = unique(summary_final$Result)
summary_final$Result = factor(summary_final$Result, levels=resultLevels, ordered=TRUE)
summary_final <- as.data.frame(summary_final) 

p_final <- ggplot(summary_final, aes(x=Panelist, y=Pct)) + geom_bar(aes(fill=Result),stat="identity", position = position_dodge(width=.85), color="grey40", width=0.80) + ggtitle("Evan Leads Overall \n Cara Leads on Segments with Themes \n Evan Leads on Segments Without Themes") + 
    theme(legend.position = c(.95,1), 
          legend.justification = c(1,1), 
          legend.key.size = unit(2, 'lines'), 
          legend.background = element_blank(), 
          text = element_text(size=25),
          plot.title = element_text(hjust = 0.5)) + 
    ylab('% Wins') + xlab('') + 
    scale_fill_manual(values=c("#FFFF00", "#E69F00", "#56B4E9")) + 
    geom_text(aes(group=Result, label=Pct), vjust=2, position = position_dodge(width=.85), size=6) +
    guides(fill=guide_legend(title=""))

lay <- rbind(c(1), c(1), c(1), c(2))
grid.arrange(grobs=list(p_final, t), layout_matrix=lay)
```